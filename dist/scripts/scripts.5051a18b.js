"use strict";var app=angular.module("slackernewsApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/posts.html",controller:"PostsCtrl"}).when("/newest",{templateUrl:"views/newest.html",controller:"PostsCtrl"}).when("/comments",{templateUrl:"views/comments.html",controller:"CommentsCtrl"}).when("/posts/:postId",{templateUrl:"views/showpost.html",controller:"PostViewCtrl"}).when("/submit",{templateUrl:"views/submit.html",controller:"SubmitCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"AuthCtrl",resolve:{user:["Auth",function(a){return a.resolveUser()}]}}).when("/register",{templateUrl:"views/register.html",controller:"AuthCtrl",resolve:{user:["Auth",function(a){return a.resolveUser()}]}}).when("/users/:userId",{templateUrl:"views/profile.html",controller:"UserCtrl"}).otherwise({redirectTo:"/"})}]).constant("FIREBASE_URL","https://slacker-news.firebaseio.com/").constant("moment",moment);app.filter("hostnameFromUrl",function(){return function(a){var b=document.createElement("a");return b.href=a,b.hostname}}),app.filter("ago",function(){return function(a){var b=moment.unix(a);return b.isValid()?b.fromNow():a}}),app.factory("User",["FIREBASE_URL","$firebase","Post","$q",function(a,b,c,d){var e=new Firebase(a),f=b(e.child("users")).$asArray(),g={get:function(a){return b(e.child("users").child(a)).$asObject()},create:function(a){var b={username:a.username,email:a.email};f.$add(b).then(function(){a.uid})},getPosts:function(a){var f=d.defer();return b(e.child("user_posts").child(a)).$asArray().$loaded().then(function(a){for(var b={},d=0;d<a.length;d++){var e=a[d].$value;b[e]=c.get(e)}f.resolve(b)}),f.promise}};return g}]),app.factory("Post",["$firebase","FIREBASE_URL",function(a,b){var c=new Firebase(b),d=a(c.child("posts")).$asArray(),e={all:d,create:function(b){return d.$add(b).then(function(d){return a(c.child("user_posts").child(b.creatorUID)).$push(d.name()),d})},get:function(b){return a(c.child("posts").child(b)).$asObject()},"delete":function(a){return d.$remove(a)},comments:function(b){return a(c.child("comments").child(b)).$asArray()}};return e}]),app.factory("Auth",["$firebaseAuth","FIREBASE_URL","$firebase","$rootScope","$location",function(a,b,c,d,e){var f=new Firebase(b);d.authObj=a(f);var g={register:function(a){d.authObj.$createUser(a).then(function(b){return console.log("User "+b.uid+" created successfully!"),g.createProfile(a),console.log("User "+a.username+" profile created successfully!"),d.authObj.$authWithPassword(a)}).then(function(a){console.log("Logged in as:",a.uid)})["catch"](function(a){console.error("Error: ",a)})},createProfile:function(a){var b={username:a.username,email:a.email},d=c(f.child("users"));return d.$set(a.uid,b)},login:function(a){d.authObj.$authWithPassword(a).then(function(a){console.log("Logged in as:",a.uid)})["catch"](function(a){console.error("Authentication failed:",a)})},guestLogin:function(){d.authObj.$authAnonymously().then(function(a){console.log("Logged in as:",a.uid),g.createProfile({uid:a.uid,username:"Guest",email:"guest@sn.com"}),console.log("Guest profile sucessfully created!"),e.path("/")})["catch"](function(a){console.error("Authentication failed:",a)})},logout:function(){d.authObj.$unauth()},resolveUser:function(){return d.authObj.$waitForAuth()},signedIn:function(){var a=d.authObj.$getAuth();return a?!0:!1},getActiveUser:function(){var a=d.authObj.$getAuth();return a?a:void 0}};return d.authObj.$onAuth(function(a){a?(console.log("Logged in as:",a.uid),d.CUid=a.uid):(console.log("Logged out"),d.CUid=null,e.path("/"))}),g}]),app.factory("Vote",["$firebase","FIREBASE_URL","$rootScope",function(a,b,c){var d=new Firebase(b),e=a(d.child("votes")).$asArray(),f={all:e,create:function(b){if(c.CUid){var e={postId:b.$id},f=a(d.child("votes").child(c.CUid));f.$set(b.$id,e)}},get:function(b){return c.CUid?a(d.child("votes").child(c.CUid).child(b.$id)).$asObject():void 0},exists:function(b){if(c.CUid){var e=a(d.child("votes").child(c.CUid)).$asArray();if(-1!=e.$indexFor(b.$id))return!0}return!1}};return f}]),app.controller("AppCtrl",["$rootScope",function(a){a.global={search:""}}]),app.controller("UserCtrl",["$scope","$routeParams","User",function(a,b,c){var d=b.userId;a.profile=c.get(d),c.getPosts(d).then(function(b){a.posts=b})}]),app.controller("PostsCtrl",["$scope","$location","$firebase","FIREBASE_URL","Auth","Post","Vote",function(a,b,c,d,e,f,g){new Firebase(d);a.posts=f.all,a.votes=g.all,a.user=e.getActiveUser(),a.post={url:"http://",title:""},a.deletePost=function(a){f["delete"](a)},a.upVote=function(a){g.create(a),$("a."+a.$id).hide()},a.voted=function(a){return g.exists(a)},a.query=function(){return $("footer.input").val()}}]),app.controller("CommentsCtrl",["$scope",function(){}]),app.controller("PostViewCtrl",["$scope","$routeParams","Post","Auth","User",function(a,b,c,d,e){a.post=c.get(b.postId),a.comments=c.comments(b.postId),a.user=d.getActiveUser(),a.signedIn=d.signedIn,a.user&&(a.profile=e.get(a.user.uid)),a.addComment=function(){if(a.commentText&&""!==a.commentText){var b={text:a.commentText,creator:a.profile.username,creatorUID:a.user.uid,createdAt:Math.round((new Date).getTime()/1e3)};a.comments.$add(b),a.commentText=""}},a.deleteComment=function(b){a.comments.$remove(b)}}]),app.controller("SubmitCtrl",["$scope","$location","Auth","Post","User",function(a,b,c,d,e){a.post={url:"http://",title:""},a.user=c.getActiveUser(),a.user&&(a.profile=e.get(a.user.uid)),a.submitPost=function(){a.post.creator=a.profile.username,a.post.creatorUID=a.user.uid,a.post.score=1,a.post.createdAt=Math.round((new Date).getTime()/1e3),d.create(a.post).then(function(c){b.path("/posts/"+c.name()),a.post={url:"http://",title:""}})}}]),app.controller("AuthCtrl",["$scope","$firebase","$location","Auth","user",function(a,b,c,d,e){e&&c.path("/"),a.login=function(a){d.login(a)},a.guestLogin=function(){return d.guestLogin()},a.register=function(a){d.register(a)}}]),app.controller("NavCtrl",["$scope","$location","Auth","User",function(a,b,c,d){a.user=c.getActiveUser(),a.user&&(a.profile=d.get(a.user.uid)),a.$on("$locationChangeStart",function(){"/"==b.path()&&($("a.nav").removeClass("active"),$("a.nav.popular").addClass("active")),"/newest"==b.path()&&($("a.nav").removeClass("active"),$("a.nav.newest").addClass("active")),"/comments"==b.path()&&($("a.nav").removeClass("active"),$("a.nav.comments").addClass("active")),"/submit"==b.path()&&($("a.nav").removeClass("active"),$("a.nav.submit").addClass("active")),"/login"==b.path()&&($("a.nav").removeClass("active"),$("a.nav.login").addClass("active")),"/register"==b.path()&&($("a.nav").removeClass("active"),$("a.nav.register").addClass("active"))}),a.logout=function(){c.logout()},a.signedIn=function(){return c.signedIn()}}]);